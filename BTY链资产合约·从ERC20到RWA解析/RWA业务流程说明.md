# RWA业务流程说明

## 一、设备与代币的关系

### 当前设计：**一个代币对应多个设备**

在当前实现中，系统采用**"一个代币对应多个设备"**的设计模式：

- ✅ **一个代币合约**可以关联**多个设备**（PV-001, PV-002, PV-003等）
- ✅ 所有设备共享同一个代币（RWAET）
- ✅ 代币持有人将按比例获得**所有关联设备**产生的总收益

### 设计优势

1. **简化管理**：不需要为每个设备部署独立的代币合约
2. **灵活扩展**：可以随时添加新设备到现有代币
3. **统一收益**：所有设备收益统一分配给代币持有人

### 示例场景

```
代币合约: 0xbd598e910DA5e78248bF11cA7aBdC9004Dc73A99 (RWAET)
├── PV-001 (光伏设备，100kW)
├── PV-002 (光伏设备，150kW)
├── PV-003 (风电设备，200kW)
└── ...

用户持有1000个RWAET代币
→ 将按比例获得所有设备产生的总收益
```

### 如果需要一个设备一个代币？

如果业务需要"一个设备一个代币"的模式，需要：
1. 为每个设备部署独立的代币合约
2. 在注册设备时，可以选择或创建新的代币合约
3. 在分发代币时，需要选择对应的设备/代币

**当前实现暂不支持**，但可以通过以下方式扩展：
- 在"资产注册"页面添加代币选择功能
- 在"代币分发"页面添加设备/代币选择下拉框

---

## 二、代币发行机制

### ERC-3643代币的发行流程

#### 1. **代币合约部署**（已完成）
- 代币合约已部署到链上
- **初始供应量为0**（没有预发行代币）
- 代币名称：RWA Energy Token (RWAET)
- 代币符号：RWAET
- 小数位数：0（整数代币）

#### 2. **代币发行 = 分发代币 = mint()函数**

**关键理解**：
- ✅ **"分发代币"就是"发行代币"**
- ✅ 通过调用 `Token.mint(address _to, uint256 _amount)` 函数实现
- ✅ **不需要预先创建代币**，mint时自动创建并分配给用户

#### 3. 完整业务流程

```
步骤1: 部署代币合约（已完成）
  └─> Token合约地址: 0xbd598e910DA5e78248bF11cA7aBdC9004Dc73A99
  └─> 初始供应量: 0

步骤2: 注册设备
  └─> 注册PV-001，关联到代币合约
  └─> 注册PV-002，关联到代币合约
  └─> ...

步骤3: 注册用户身份
  └─> 调用 IdentityRegistry.registerIdentity()
  └─> 用户必须通过身份验证才能接收代币

步骤4: 分发代币（发行代币）
  └─> 调用 Token.mint(userAddress, amount)
  └─> 代币自动创建并分配给用户
  └─> 总供应量自动增加
```

### mint()函数的要求

```solidity
function mint(address _to, uint256 _amount) external onlyAgent
```

**前提条件**：
1. ✅ 调用者必须是**Agent**（已设置）
2. ✅ 接收地址 `_to` 必须已通过**身份验证**（IdentityRegistry.isVerified(_to) == true）
3. ✅ 必须通过**合规检查**（Compliance.canTransfer）

### 代币数量管理

- **初始状态**：totalSupply = 0（没有代币）
- **每次mint**：totalSupply += amount（自动增加）
- **无上限**：可以无限次mint（除非在Compliance中设置限制）

---

## 三、完整的业务闭环

### 场景示例：光伏设备收益分配

```
1. 注册设备
   Owner → AssetRegistry.registerAsset("PV-001", "光伏", "北京", 100kW, Token合约地址)
   → 设备PV-001关联到代币合约

2. 注册用户
   Agent → IdentityRegistry.registerIdentity(userAddress, identity, countryCode)
   → 用户通过身份验证

3. 分发代币
   Agent → Token.mint(userAddress, 10000)
   → 用户获得10000个RWAET代币

4. 设备产生收益
   实际业务 → 光伏设备发电产生收益（链下）

5. 分配收益
   Owner → RevenueDistributor.distributeRevenue(amount, "PV-001")
   → 收益按代币持仓比例分配给所有持有人

6. 用户提取收益
   User → RevenueDistributor.claimRevenue()
   → 用户提取自己的收益份额
```

---

## 四、常见问题

### Q1: 为什么不需要预先创建代币？

**A**: ERC-3643采用**按需发行**的模式：
- 代币合约部署时，供应量为0
- 通过 `mint()` 函数按需创建代币
- 每次mint都会增加总供应量

### Q2: 一个代币对应多个设备，收益如何分配？

**A**: 收益分配逻辑：
1. 所有关联设备的收益汇总到 `RevenueDistributor`
2. 按代币持仓比例分配给所有持有人
3. 持有代币越多，获得的收益份额越大

### Q3: 如果需要一个设备一个代币怎么办？

**A**: 需要扩展功能：
1. 在注册设备时，可以选择或创建新的代币合约
2. 在分发代币时，需要选择对应的设备/代币
3. 需要管理多个代币合约地址

### Q4: 代币可以销毁吗？

**A**: 可以。ERC-3643支持 `burn()` 函数：
- 只有Agent可以调用
- 会减少总供应量
- 需要用户有足够的代币余额

---

## 五、技术实现细节

### 合约交互流程图

```
┌─────────────────┐
│  AssetRegistry  │ ← Owner注册设备
└────────┬────────┘
         │ 关联
         ▼
┌─────────────────┐
│  Token (ERC3643)│ ← Agent mint代币
└────────┬────────┘
         │ 验证
         ▼
┌─────────────────┐
│IdentityRegistry │ ← Agent注册用户
└─────────────────┘

┌─────────────────┐
│RevenueDistributor│ ← Owner分配收益
└────────┬─────────┘
         │ 按比例分配
         ▼
    ┌─────────┐
    │ 用户提取 │
    └─────────┘
```

### 关键合约地址（BTY测试网）

- **Token合约**: `0xbd598e910DA5e78248bF11cA7aBdC9004Dc73A99`
- **IdentityRegistry**: `0x18AafaA4Cde2c18293519FC5C97609FB640AF2E4`
- **AssetRegistry**: `0xce15e646B4aA27A53384f9bBad29A89013690F29`
- **RevenueDistributor**: `0xaeF73aa5E5Da2CeE1e6846e13d91B75A4Fb08159`

---

## 总结

1. **设备与代币**：当前是一个代币对应多个设备，共享收益
2. **代币发行**：通过mint()函数实现，分发即发行
3. **业务流程**：部署 → 注册设备 → 注册用户 → 分发代币 → 分配收益 → 提取收益

如果业务需要调整为"一个设备一个代币"，需要扩展前端和合约功能。

